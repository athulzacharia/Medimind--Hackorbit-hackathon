<!DOCTYPE html>
<html>
<head>
  <title>Analytics</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h2>MediMind</h2>
      <ul>
        <li onclick="navigate('index.html')">üè† Dashboard</li>
        <li onclick="navigate('upload.html')">üìÅ Upload Records</li>
        <li onclick="navigate('analytics.html')" class="active">üìä Health Analytics</li>
        <li onclick="navigate('pill.html')">üíä Pill Reminder</li>
        <li onclick="navigate('chatbot.html')">ü§ñ Chatbot</li>
      </ul>
    </aside>

    <main class="main-content">
      <header class="topbar">
        <input type="text" placeholder="Search health records..." />
        <button class="profile-btn">Neha üë§</button>
      </header>

      <h2 style="padding:20px;">üìä Health Analytics Dashboard</h2>

      <div id="loadingIndicator" style="text-align: center; padding: 20px; display: none;">
        <p>Loading analytics data...</p>
      </div>

      <div id="noDataMessage" style="text-align: center; padding: 40px; display: none;">
        <h3>No Health Data Available</h3>
        <p>Please upload some health records first to see analytics.</p>
        <button onclick="navigate('upload.html')" style="padding: 10px 20px; margin-top: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Upload Records
        </button>
      </div>

      <div class="analytics-container" id="analyticsContainer" style="padding: 20px; display: none;">
        <!-- Summary Cards -->
        <div class="summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
          <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
            <h3>Total Records</h3>
            <p id="totalRecords" style="font-size: 2em; margin: 10px 0;">0</p>
          </div>
          <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
            <h3>Latest BP</h3>
            <p id="latestBP" style="font-size: 1.5em; margin: 10px 0;">N/A</p>
          </div>
          <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
            <h3>Latest Glucose</h3>
            <p id="latestGlucose" style="font-size: 1.5em; margin: 10px 0;">N/A</p>
          </div>
          <div class="summary-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 10px; color: white; text-align: center;">
            <h3>Active Medications</h3>
            <p id="activeMedications" style="font-size: 2em; margin: 10px 0;">0</p>
          </div>
        </div>

        <!-- Charts Container -->
        <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
          <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">Blood Pressure Trends</h3>
            <canvas id="bpChart" width="400" height="200"></canvas>
          </div>
          
          <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">Glucose Levels</h3>
            <canvas id="glucoseChart" width="400" height="200"></canvas>
          </div>
          
          <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">Cholesterol Levels</h3>
            <canvas id="cholChart" width="400" height="200"></canvas>
          </div>
          
          <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">Medication Distribution</h3>
            <canvas id="medicationChart" width="400" height="200"></canvas>
          </div>
          
          <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">Diagnosis Frequency</h3>
            <canvas id="diagnosisChart" width="400" height="200"></canvas>
          </div>

          <div class="chart-container" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">Health Metrics Timeline</h3>
            <canvas id="timelineChart" width="400" height="200"></canvas>
          </div>
        </div>

        <!-- Recent Records Table -->
        <div class="recent-records" style="margin-top: 30px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
          <h3 style="margin-bottom: 15px; color: #333;">Recent Health Records</h3>
          <div id="recentRecordsTable" style="overflow-x: auto;">
            <!-- Table will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    function navigate(page) {
      window.location.href = page;
    }

    let charts = {};

    async function fetchAnalytics() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const noDataMessage = document.getElementById('noDataMessage');
      const analyticsContainer = document.getElementById('analyticsContainer');

      loadingIndicator.style.display = 'block';
      noDataMessage.style.display = 'none';
      analyticsContainer.style.display = 'none';

      try {
        const response = await fetch('http://127.0.0.1:5000/analytics_data');
        const data = await response.json();

        loadingIndicator.style.display = 'none';

        if (!data.has_data) {
          noDataMessage.style.display = 'block';
          return;
        }

        analyticsContainer.style.display = 'block';
        updateSummaryCards(data.summary);
        createCharts(data);
        updateRecentRecordsTable(data.recent_records);

      } catch (error) {
        console.error('Error fetching analytics:', error);
        loadingIndicator.style.display = 'none';
        noDataMessage.style.display = 'block';
      }
    }

    function updateSummaryCards(summary) {
      document.getElementById('totalRecords').textContent = summary.total_records;
      document.getElementById('latestBP').textContent = summary.latest_bp || 'N/A';
      document.getElementById('latestGlucose').textContent = summary.latest_glucose || 'N/A';
      document.getElementById('activeMedications').textContent = summary.active_medications;
    }

    function createCharts(data) {
      // Destroy existing charts
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};

      // Blood Pressure Chart
      if (data.blood_pressure.values.length > 0) {
        const bpCtx = document.getElementById('bpChart').getContext('2d');
        charts.bp = new Chart(bpCtx, {
          type: 'line',
          data: {
            labels: data.blood_pressure.dates,
            datasets: [{
              label: 'Systolic BP',
              data: data.blood_pressure.systolic,
              borderColor: '#e74c3c',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              tension: 0.4,
              fill: true
            }, {
              label: 'Diastolic BP',
              data: data.blood_pressure.diastolic,
              borderColor: '#3498db',
              backgroundColor: 'rgba(52, 152, 219, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: false,
                title: {
                  display: true,
                  text: 'mmHg'
                }
              }
            }
          }
        });
      }

      // Glucose Chart
      if (data.glucose.values.length > 0) {
        const glucoseCtx = document.getElementById('glucoseChart').getContext('2d');
        charts.glucose = new Chart(glucoseCtx, {
          type: 'bar',
          data: {
            labels: data.glucose.dates,
            datasets: [{
              label: 'Glucose Level (mg/dL)',
              data: data.glucose.values,
              backgroundColor: 'rgba(26, 188, 156, 0.8)',
              borderColor: '#1abc9c',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'mg/dL'
                }
              }
            }
          }
        });
      }

      // Cholesterol Chart
      if (data.cholesterol.values.length > 0) {
        const cholCtx = document.getElementById('cholChart').getContext('2d');
        charts.cholesterol = new Chart(cholCtx, {
          type: 'bar',
          data: {
            labels: data.cholesterol.dates,
            datasets: [{
              label: 'Cholesterol Level (mg/dL)',
              data: data.cholesterol.values,
              backgroundColor: 'rgba(230, 126, 34, 0.8)',
              borderColor: '#e67e22',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'mg/dL'
                }
              }
            }
          }
        });
      }

      // Medication Chart
      if (Object.keys(data.medications).length > 0) {
        const medCtx = document.getElementById('medicationChart').getContext('2d');
        charts.medication = new Chart(medCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(data.medications),
            datasets: [{
              label: 'Medications',
              data: Object.values(data.medications),
              backgroundColor: [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12',
                '#9b59b6', '#1abc9c', '#34495e', '#e67e22'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }

      // Diagnosis Chart
      if (Object.keys(data.diagnosis).length > 0) {
        const diagCtx = document.getElementById('diagnosisChart').getContext('2d');
        charts.diagnosis = new Chart(diagCtx, {
          type: 'bar',
          data: {
            labels: Object.keys(data.diagnosis),
            datasets: [{
              label: 'Diagnosis Frequency',
              data: Object.values(data.diagnosis),
              backgroundColor: 'rgba(52, 73, 94, 0.8)',
              borderColor: '#34495e',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      // Timeline Chart
      if (data.timeline.dates.length > 0) {
        const timelineCtx = document.getElementById('timelineChart').getContext('2d');
        charts.timeline = new Chart(timelineCtx, {
          type: 'line',
          data: {
            labels: data.timeline.dates,
            datasets: [{
              label: 'Records Uploaded',
              data: data.timeline.counts,
              borderColor: '#8e44ad',
              backgroundColor: 'rgba(142, 68, 173, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }
    }

    function updateRecentRecordsTable(records) {
      const tableContainer = document.getElementById('recentRecordsTable');
      
      if (records.length === 0) {
        tableContainer.innerHTML = '<p>No recent records found.</p>';
        return;
      }

      let tableHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #f8f9fa;">
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Date</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">File</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Key Findings</th>
            </tr>
          </thead>
          <tbody>
      `;

      records.forEach(record => {
        tableHTML += `
          <tr style="border-bottom: 1px solid #dee2e6;">
            <td style="padding: 12px;">${record.date}</td>
            <td style="padding: 12px;">${record.filename}</td>
            <td style="padding: 12px;">${record.key_findings}</td>
          </tr>
        `;
      });

      tableHTML += '</tbody></table>';
      tableContainer.innerHTML = tableHTML;
    }

    window.onload = fetchAnalytics;
  </script>
</body>
</html>